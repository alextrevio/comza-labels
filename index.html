<!DOCTYPE html>
<!-- v4.1 -->
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grupo COMZA ‚Äî Gestor de Etiquetas e Inventario</title>
<link rel="icon" href="/comza-logo.svg" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<style>
:root{
    --black:#000;--bg1:#0a0a0a;--bg2:#111;--bg3:#181818;--bg4:#222;--bg5:#2a2a2a;
    --border:#1e1e1e;--border2:#2a2a2a;--border3:#333;
    --white:#fff;--t1:#f5f5f5;--t2:#b0b0b0;--t3:#777;--t4:#555;
    --green:#2ecc71;--green-bg:rgba(46,204,113,.1);--green-b:rgba(46,204,113,.25);
    --red:#e74c3c;--red-bg:rgba(231,76,60,.08);--red-b:rgba(231,76,60,.2);
    --amber:#f39c12;--amber-bg:rgba(243,156,18,.08);--amber-b:rgba(243,156,18,.2);
    --blue:#3498db;--blue-bg:rgba(52,152,219,.08);--blue-b:rgba(52,152,219,.2);
    --font:'Assistant',system-ui,sans-serif;--mono:'IBM Plex Mono',monospace;
    --r:8px;--r2:12px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--black);color:var(--t1);min-height:100vh;-webkit-font-smoothing:antialiased}
::selection{background:var(--green-b);color:var(--green)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}

.shell{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
.sb{background:var(--bg1);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto}
.sb-brand{padding:20px 16px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.sb-logo{height:26px;filter:invert(1) brightness(1.8)}
.sb-name{font-weight:700;font-size:14px;letter-spacing:.5px}
.sb-sub{font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:1.5px;margin-top:1px}
.sb-nav{flex:1;padding:12px 8px;display:flex;flex-direction:column;gap:1px}
.sb-sec{padding:14px 10px 4px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--t4)}
.sb-link{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--r);cursor:pointer;font-size:12.5px;font-weight:500;color:var(--t2);transition:.15s;border:1px solid transparent}
.sb-link:hover{background:var(--bg3);color:var(--t1)}
.sb-link.on{background:var(--green-bg);color:var(--green);border-color:var(--green-b)}
.sb-link svg{width:15px;height:15px;flex-shrink:0;opacity:.6}.sb-link.on svg{opacity:1}
.sb-badge{margin-left:auto;background:var(--green);color:var(--black);font-size:9px;font-weight:700;padding:1px 6px;border-radius:99px;font-family:var(--mono)}
.sb-ft{padding:12px 16px;border-top:1px solid var(--border)}
.sb-status{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--t3)}
.sb-dot{width:6px;height:6px;border-radius:50%;background:var(--t4);flex-shrink:0}.sb-dot.on{background:var(--green);box-shadow:0 0 8px rgba(46,204,113,.5)}

.main{padding:28px 32px;overflow-y:auto;max-height:100vh}
.v{display:none;animation:fadeIn .2s ease}.v.on{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.hd{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px}
.hd h1{font-size:18px;font-weight:700}.hd .sub{color:var(--t3);font-size:11px;margin-top:1px}
.hd-act{display:flex;gap:6px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:7px 14px;border-radius:var(--r);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:.15s;border:1px solid transparent;outline:none;white-space:nowrap}
.btn svg{width:13px;height:13px}
.btn-g{background:var(--green);color:var(--black)}.btn-g:hover{background:#27ae60;box-shadow:0 2px 10px rgba(46,204,113,.2);transform:translateY(-1px)}
.btn-o{background:transparent;color:var(--t2);border-color:var(--border2)}.btn-o:hover{background:var(--bg3);color:var(--t1)}
.btn-r{background:var(--red-bg);color:var(--red);border-color:var(--red-b)}.btn-r:hover{background:rgba(231,76,60,.14)}
.btn-a{background:var(--amber-bg);color:var(--amber);border-color:var(--amber-b)}
.btn-b{background:var(--blue-bg);color:var(--blue);border-color:var(--blue-b)}
.btn:disabled{opacity:.35;pointer-events:none}.btn-sm{padding:5px 10px;font-size:11px}.btn-w{width:100%}

.fg{margin-bottom:12px}
.fg label{display:block;font-size:10px;font-weight:600;color:var(--t3);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:8px 10px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);color:var(--t1);font-family:var(--font);font-size:12.5px;transition:.15s;outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--green);box-shadow:0 0 0 2px var(--green-bg)}
.fg textarea{resize:vertical;min-height:60px}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.fg-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}

.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px}
.st{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:14px 16px}
.st-l{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--t4);margin-bottom:3px}
.st-v{font-size:22px;font-weight:800;font-family:var(--mono);letter-spacing:-.5px}

.srch{position:relative;margin-bottom:16px}
.srch svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--t4)}
.srch input{width:100%;padding:9px 12px 9px 32px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);color:var(--t1);font-family:var(--font);font-size:12.5px;outline:none;transition:.15s}
.srch input:focus{border-color:var(--green);box-shadow:0 0 0 2px var(--green-bg)}
.srch input::placeholder{color:var(--t4)}

.pg{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.pc{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;transition:.2s;cursor:pointer}
.pc:hover{border-color:var(--green);transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.3)}
.pc-img{width:100%;height:160px;background:var(--bg3);display:grid;place-items:center;overflow:hidden}
.pc-img img{width:100%;height:100%;object-fit:cover}
.pc-bd{padding:10px 12px}
.pc-t{font-size:12px;font-weight:600;line-height:1.3;margin-bottom:2px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.pc-sku{font-family:var(--mono);font-size:9px;color:var(--green);margin-bottom:6px}
.pc-pr{font-family:var(--mono);font-size:14px;font-weight:700;color:var(--green)}.pc-pr .c{font-size:9px;color:var(--t3);font-weight:400;margin-left:2px}
.pc-stk{margin-top:4px;font-size:9px;color:var(--t3)}
.pc-ft{padding:6px 12px;border-top:1px solid var(--border);display:flex;gap:5px}
.pc-ft .btn{flex:1;font-size:10px;padding:5px 6px}

/* CONNECT */
.cx{max-width:440px;margin:40px auto;background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:36px;text-align:center}
.cx h2{font-size:18px;font-weight:700;margin-bottom:4px}.cx>p{color:var(--t3);font-size:12px;margin-bottom:24px;line-height:1.5}
.cx-code{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:12px;font-family:var(--mono);font-size:10px;color:var(--t2);line-height:1.7;text-align:left;margin-bottom:20px}

/* PANELS */
.po{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:90;backdrop-filter:blur(2px)}.po.on{display:block}
.pn{display:none;position:fixed;top:0;right:0;width:460px;height:100vh;background:var(--bg1);border-left:1px solid var(--border);z-index:91;overflow-y:auto;box-shadow:-6px 0 24px rgba(0,0,0,.35)}.pn.on{display:block;animation:slideR .2s ease}
@keyframes slideR{from{transform:translateX(20px);opacity:0}to{transform:none;opacity:1}}
.pn-h{position:sticky;top:0;background:var(--bg1);padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;z-index:5}
.pn-h h3{font-size:13px;font-weight:600}.pn-b{padding:18px}
.pn-img{width:100%;height:160px;background:var(--bg3);border-radius:var(--r);display:grid;place-items:center;overflow:hidden;margin-bottom:16px;border:1px solid var(--border)}
.pn-img img{width:100%;height:100%;object-fit:cover}
.pn-act{display:flex;gap:6px;margin-top:16px}.pn-act .btn{flex:1}

/* LABEL 4x6 - PIXEL PERFECT replica of physical COMZA label */
.la{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
.lp-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:20px;display:flex;flex-direction:column;align-items:center;gap:14px;position:sticky;top:28px;overflow:visible}
.lp-tag{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--t4)}

.label{background:#fff;width:384px;height:576px;padding:32px 30px 24px;font-family:'Assistant',Arial,Helvetica,sans-serif;color:#333;display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,.4);transform-origin:top center}
.label-name{font-size:15px;font-weight:400;font-style:italic;color:#888;line-height:1.3;margin-bottom:12px}
.label-sku{font-size:48px;font-weight:800;color:#444;line-height:1;margin-bottom:20px;letter-spacing:.5px;overflow-wrap:break-word;word-break:break-word}
.price-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px}
.price-col.right{text-align:right}
.price-amount{font-size:15px;font-weight:700;color:#555;letter-spacing:.3px}
.price-label{font-size:10px;font-weight:700;color:#777;text-transform:uppercase;letter-spacing:.3px;line-height:1.4}
.promo-section{margin-top:20px}
.promo-title{text-align:center;font-size:24px;font-weight:800;color:#333;text-transform:uppercase;letter-spacing:6px;margin-bottom:14px}
.promo-row .price-amount{font-size:18px;font-weight:800;color:#333}
.promo-row .price-label{font-size:11px;font-weight:800;color:#555}
.label.has-promo .price-row:not(.promo-row) .price-amount{font-size:13px;font-weight:400;color:#999}
.label.has-promo .price-row:not(.promo-row) .price-label{font-size:9px;font-weight:400;color:#aaa}
.label-spacer{flex:1}
.label-specs{text-align:center;font-size:14px;font-weight:400;color:#666;letter-spacing:.3px;margin-bottom:16px}
.label-brand{text-align:center}.label-brand img{height:28px}
.lbl-act{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
@media(max-width:500px){.lp-box{position:static!important}.label{transform:scale(0.78);margin-bottom:-130px}}

.lbl-act{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}

/* LABEL 3x1 - Refacciones */
.lbl-sm{background:#fff;color:#111;width:288px;height:96px;padding:8px 10px;border-radius:1px;box-shadow:0 4px 12px rgba(0,0,0,.3);font-family:'Assistant',Arial,sans-serif;display:flex;align-items:center;gap:8px}
.lbl-sm-qr{flex-shrink:0;width:76px;height:76px;display:flex;align-items:center;justify-content:center}
.lbl-sm-qr canvas,.lbl-sm-qr img{max-width:76px!important;max-height:76px!important}
.lbl-sm-info{flex:1;overflow:hidden}
.lbl-sm-name{font-size:11px;font-weight:700;line-height:1.2;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.lbl-sm-cond{font-size:9px;font-weight:600;color:#666;margin-top:2px}

/* REFACCIONES TABLE */
.rtbl{width:100%;border-collapse:collapse;font-size:11.5px}
.rtbl th{text-align:left;padding:8px 10px;background:var(--bg3);color:var(--t3);font-size:9px;text-transform:uppercase;letter-spacing:1px;font-weight:700;border-bottom:1px solid var(--border);position:sticky;top:0}
.rtbl td{padding:8px 10px;border-bottom:1px solid var(--border);color:var(--t1);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.rtbl tr:hover td{background:var(--bg3)}
.rtbl-wrap{max-height:60vh;overflow-y:auto;border:1px solid var(--border);border-radius:var(--r2)}

.tag{display:inline-flex;padding:2px 7px;border-radius:99px;font-size:9px;font-weight:700;font-family:var(--mono)}
.tag-g{background:var(--green-bg);color:var(--green);border:1px solid var(--green-b)}
.tag-r{background:var(--red-bg);color:var(--red);border:1px solid var(--red-b)}
.tag-a{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-b)}
.tag-b{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-b)}

.tst-c{position:fixed;top:14px;right:14px;z-index:200;display:flex;flex-direction:column;gap:4px}
.tst{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);padding:8px 14px;font-size:11px;box-shadow:0 4px 16px rgba(0,0,0,.25);display:flex;align-items:center;gap:6px;animation:tIn .2s ease;min-width:220px}
.tst.ok{border-left:3px solid var(--green)}.tst.err{border-left:3px solid var(--red)}.tst.inf{border-left:3px solid var(--blue)}
@keyframes tIn{from{transform:translateX(40px);opacity:0}to{transform:none;opacity:1}}

.empty{text-align:center;padding:30px;color:var(--t4)}.empty h3{font-size:13px;color:var(--t2);margin-bottom:2px}.empty p{font-size:11px}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border2);border-top-color:var(--green);border-radius:50%;animation:sp .5s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;gap:8px;color:var(--t3);font-size:11px}

.prb{background:var(--bg3);border:1px dashed var(--border2);border-radius:var(--r);padding:10px;margin-top:4px}
.prb-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.prb-h span{font-size:10px;font-weight:700;color:var(--amber)}
.chk{display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer}.chk input{accent-color:var(--green);width:13px;height:13px}

.sc{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:18px;margin-bottom:12px}
.sc h3{font-size:13px;font-weight:600;margin-bottom:2px}.sc .desc{font-size:10px;color:var(--t4);margin-bottom:14px}

@media print{
    body *{visibility:hidden!important}
    .label,.label *,.lbl-sm,.lbl-sm *{visibility:visible!important}
    .label{position:fixed!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;box-shadow:none!important;width:4in!important;height:6in!important;padding:0.3in!important}
    .lbl-sm{position:fixed!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;box-shadow:none!important;width:3in!important;height:1in!important;padding:0.08in!important}
}
@media(max-width:800px){.shell{grid-template-columns:1fr}.sb{display:none}.main{padding:14px}.la{grid-template-columns:1fr}.pn{width:100%}.pg{grid-template-columns:1fr}.stats{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="shell">
<aside class="sb">
    <div class="sb-brand"><img src="/comza-logo.svg" alt="Grupo COMZA" class="sb-logo"><div><div class="sb-name">Grupo Comza</div><div class="sb-sub">Inventario & Etiquetas</div></div></div>
    <nav class="sb-nav">
        <div class="sb-sec">Shopify</div>
        <div class="sb-link on" data-v="products" onclick="go('products')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Productos<span class="sb-badge" id="nc">0</span></div>
        <div class="sb-link" data-v="label" onclick="go('label')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="2" width="12" height="20" rx="1"/><line x1="9" y1="6" x2="15" y2="6"/><line x1="9" y1="10" x2="15" y2="10"/></svg>Etiqueta Producto</div>
        <div class="sb-sec">Refacciones</div>
        <div class="sb-link" data-v="refacciones" onclick="go('refacciones')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>Inventario<span class="sb-badge" id="nR">0</span></div>
        <div class="sb-link" data-v="ref-label" onclick="go('ref-label')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h.01M7 12h.01M12 7h.01"/></svg>Etiqueta Refacci√≥n</div>
        <div class="sb-sec">Herramientas</div>
        <div class="sb-link" data-v="herramientas" onclick="go('herramientas')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>Inventario<span class="sb-badge" id="nH">0</span></div>
        <div class="sb-sec">Sistema</div>
        <div class="sb-link" data-v="settings" onclick="go('settings')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>Configuraci√≥n</div>
    </nav>
    <div class="sb-ft"><div class="sb-status"><span class="sb-dot" id="dot"></span><span id="dotT">Verificando...</span></div></div>
</aside>
<main class="main">

<!-- CONNECT -->
<div class="v on" id="v-connect">
<div class="cx"><img src="/comza-logo.svg" alt="COMZA" style="height:34px;filter:invert(1);margin-bottom:14px">
<h2>Configura tu conexi√≥n</h2><p>Agrega las credenciales de Shopify en las variables de entorno de Vercel.</p>
<div class="cx-code">SHOPIFY_STORE_DOMAIN=tu-tienda<br>SHOPIFY_CLIENT_ID=...<br>SHOPIFY_CLIENT_SECRET=...<br>COMPANY_NAME=COMZA</div>
<button class="btn btn-g btn-w" onclick="checkConnection()">Verificar Conexi√≥n</button>
<div style="margin-top:12px"><button class="btn btn-o btn-sm" onclick="loadDemo()">Cargar demo</button></div></div></div>

<!-- PRODUCTS -->
<div class="v" id="v-products">
<div class="hd"><div><h1>Productos</h1><div class="sub">Sincronizado con Shopify</div></div>
<div class="hd-act"><button class="btn btn-g" onclick="opNewProd()">+ Nuevo Producto</button><button class="btn btn-o btn-sm" onclick="fetchProducts()">‚Üª Actualizar</button></div></div>
<div class="stats"><div class="st"><div class="st-l">Total</div><div class="st-v" id="sT">0</div></div><div class="st"><div class="st-l">Con SKU</div><div class="st-v" id="sS">0</div></div><div class="st"><div class="st-l">Sin SKU</div><div class="st-v" id="sN">0</div></div><div class="st"><div class="st-l">Inventario</div><div class="st-v" id="sI">0</div></div></div>
<div class="srch"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="q" placeholder="Buscar por nombre, SKU, tipo o marca..." oninput="filterP()"></div>
<div class="pg" id="grid"><div class="loading"><div class="spinner"></div>Cargando...</div></div></div>

<!-- PRODUCT LABEL 4x6 -->
<div class="v" id="v-label">
<div class="hd"><div><h1>Etiqueta de Producto</h1><div class="sub">Formato 4√ó6 pulgadas para impresora t√©rmica HP</div></div></div>
<div class="la"><div>
    <div class="fg"><label>Producto</label><select id="lSel" onchange="fillL()"><option value="">‚Äî Seleccionar ‚Äî</option></select></div>
    <div class="fg"><label>Nombre</label><input type="text" id="lNm" placeholder="Horno Combi Rational SCC WE 202G" oninput="updL()"></div>
    <div class="fg"><label>Condici√≥n</label><input type="text" id="lCd" placeholder="Reacondicionado" oninput="updL()"></div>
    <div class="fg"><label>SKU</label><input type="text" id="lSk" placeholder="E258" style="font-family:var(--mono);font-size:14px;font-weight:700" oninput="updL()"></div>
    <div class="fg-row">
        <div class="fg"><label>Precio IVA Incluido</label><input type="text" id="lPI" placeholder="518,400" oninput="updL()"></div>
        <div class="fg"><label>Precio Pago en Efectivo</label><input type="text" id="lPC" placeholder="480,000" oninput="updL()"></div>
    </div>
    <div class="prb"><div class="prb-h"><span>üè∑Ô∏è Promoci√≥n</span><label class="chk"><input type="checkbox" id="lHP" onchange="togPr();updL()"> Activar</label></div>
    <div id="prF" style="display:none"><div class="fg-row">
        <div class="fg" style="margin:0"><label>Promo IVA Incluido</label><input type="text" id="lPrI" placeholder="473,000" oninput="updL()"></div>
        <div class="fg" style="margin:0"><label>Promo Pago en Efectivo</label><input type="text" id="lPrC" placeholder="430,000" oninput="updL()"></div>
    </div></div></div>
    <div style="margin-top:8px;padding:10px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--border2)">
        <div style="font-size:10px;font-weight:700;color:var(--t3);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px">Especificaciones (para etiqueta)</div>
        <div class="fg" style="margin:0"><label>Texto de especificaciones</label><input type="text" id="lSpTxt" placeholder="Luz 220 v / 1 ph / 20 Charolas / Gas" oninput="updL()"></div>
    </div>
</div>
<div class="lp-box"><div class="lp-tag">Vista previa 4√ó6"</div>
<div class="label has-promo" id="lblP">
    <div class="label-name" id="L-nm">Horno Combi Rational SCC WE 202G (Reacondicionado)</div>
    <div class="label-sku" id="L-sku">SKU: E258</div>
    <div class="price-row" id="L-mainPrices">
        <div class="price-col"><div class="price-amount" id="L-pi">$ 518,400 MXN</div><div class="price-label">IVA INCLUIDO</div></div>
        <div class="price-col right"><div class="price-amount" id="L-pc">$480,000 MXN</div><div class="price-label">PAGO EN EFECTIVO</div></div>
    </div>
    <div class="promo-section" id="L-prW">
        <div class="promo-title">PROMOCI√ìN</div>
        <div class="price-row promo-row">
            <div class="price-col"><div class="price-amount" id="L-pri">$ 473,000 MXN</div><div class="price-label">IVA INCLUIDO</div></div>
            <div class="price-col right"><div class="price-amount" id="L-prc">$430,000 MXN</div><div class="price-label">PAGO EN<br>EFECTIVO</div></div>
        </div>
    </div>
    <div class="label-spacer"></div>
    <div class="label-specs" id="L-sp">Luz 220 v / 1 ph / 20 Charolas / Gas</div>
    <div class="label-brand"><img src="/comza-logo.svg" alt="Grupo COMZA"></div>
</div>
<div class="lbl-act">
    <button class="btn btn-g" onclick="printL()">üñ®Ô∏è Imprimir</button>
    <button class="btn btn-o" onclick="dlPNG('lblP','etiqueta')">üì• PNG</button></div></div></div></div>

<!-- REFACCIONES -->
<div class="v" id="v-refacciones">
<div class="hd"><div><h1>Inventario de Refacciones</h1><div class="sub">Alta, baja y pr√©stamo de refacciones</div></div>
<div class="hd-act"><button class="btn btn-g" onclick="opRefNew()">+ Nueva Refacci√≥n</button></div></div>
<div class="stats" id="rStats"><div class="st"><div class="st-l">Total</div><div class="st-v" id="rT">0</div></div><div class="st"><div class="st-l">Funciona</div><div class="st-v" id="rF">0</div></div><div class="st"><div class="st-l">En Pr√©stamo</div><div class="st-v" id="rP">0</div></div><div class="st"><div class="st-l">Baja</div><div class="st-v" id="rB">0</div></div></div>
<div class="srch"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="rQ" placeholder="Buscar refacciones..." oninput="filterR()"></div>
<div class="rtbl-wrap"><table class="rtbl"><thead><tr><th>Nombre</th><th>Marca</th><th>Modelo</th><th>Condici√≥n</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="rGrid"></tbody></table></div></div>

<!-- REFACCION LABEL 3x1 -->
<div class="v" id="v-ref-label">
<div class="hd"><div><h1>Etiqueta de Refacci√≥n</h1><div class="sub">Formato 3√ó1 pulgadas con c√≥digo QR</div></div></div>
<div class="la"><div>
    <div class="fg"><label>Refacci√≥n</label><select id="rlSel" onchange="fillRL()"><option value="">‚Äî Seleccionar ‚Äî</option></select></div>
    <div class="fg"><label>Nombre</label><input type="text" id="rlNm" placeholder="Compresor Copeland"></div>
    <div class="fg"><label>Condici√≥n</label><select id="rlCd"><option>Nueva</option><option>Usada</option></select></div>
    <div class="fg"><label>ID (para QR)</label><input type="text" id="rlId" placeholder="REF-001" style="font-family:var(--mono);font-weight:600"></div>
    <button class="btn btn-g btn-w" onclick="updRL()">Generar Etiqueta</button>
</div>
<div class="lp-box"><div class="lp-tag">Vista previa 3√ó1"</div>
<div class="lbl-sm" id="lblR">
    <div class="lbl-sm-qr" id="rlQR"></div>
    <div class="lbl-sm-info"><div class="lbl-sm-name" id="RL-nm">Compresor Copeland</div><div class="lbl-sm-cond" id="RL-cd">Nueva</div></div>
</div>
<div class="lbl-act" style="margin-top:10px">
    <button class="btn btn-g btn-sm" onclick="printRL()">üñ®Ô∏è Imprimir</button>
    <button class="btn btn-o btn-sm" onclick="dlPNG('lblR','ref-etiqueta')">üì• PNG</button></div></div></div></div>

<!-- HERRAMIENTAS -->
<div class="v" id="v-herramientas">
<div class="hd"><div><h1>Inventario de Herramientas</h1><div class="sub">Alta, baja y pr√©stamo de herramientas</div></div>
<div class="hd-act"><button class="btn btn-g" onclick="opHerrNew()">+ Nueva Herramienta</button></div></div>
<div class="stats"><div class="st"><div class="st-l">Total</div><div class="st-v" id="hT">0</div></div><div class="st"><div class="st-l">Disponible</div><div class="st-v" id="hD">0</div></div><div class="st"><div class="st-l">En Pr√©stamo</div><div class="st-v" id="hP">0</div></div><div class="st"><div class="st-l">Baja</div><div class="st-v" id="hB">0</div></div></div>
<div class="srch"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="hQ" placeholder="Buscar herramientas..." oninput="filterHerr()"></div>
<div class="rtbl-wrap"><table class="rtbl"><thead><tr><th>Nombre</th><th>Marca</th><th>Modelo</th><th>N¬∞ Serie</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="hGrid"></tbody></table></div></div>

<!-- SETTINGS -->
<div class="v" id="v-settings">
<div class="hd"><div><h1>Configuraci√≥n</h1><div class="sub">Conexi√≥n y preferencias</div></div></div>
<div class="sc"><h3>Conexi√≥n Shopify</h3><div class="desc">Estado de la tienda</div>
<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0"><div><div style="font-size:11px;font-weight:600">Tienda</div><div style="font-size:10px;color:var(--t3)" id="cfS">‚Äî</div></div><span class="tag tag-r" id="cfT">Desconectada</span></div>
<div style="margin-top:10px"><button class="btn btn-o btn-sm" onclick="checkConnection()">Verificar</button></div></div>
<div class="sc"><h3>Datos de Refacciones</h3><div class="desc">Exportar o importar inventario de refacciones</div>
<div style="display:flex;gap:6px"><button class="btn btn-o btn-sm" onclick="exportRef()">üì§ Exportar JSON</button><button class="btn btn-o btn-sm" onclick="document.getElementById('impRef').click()">üì• Importar JSON</button><input type="file" id="impRef" accept=".json" style="display:none" onchange="importRef(event)"></div></div>
<div class="sc"><h3>Datos de Herramientas</h3><div class="desc">Exportar o importar inventario de herramientas</div>
<div style="display:flex;gap:6px"><button class="btn btn-o btn-sm" onclick="exportHerr()">üì§ Exportar JSON</button><button class="btn btn-o btn-sm" onclick="document.getElementById('impHerr').click()">üì• Importar JSON</button><input type="file" id="impHerr" accept=".json" style="display:none" onchange="importHerr(event)"></div></div></div>

</main></div>

<!-- PANEL OVERLAY -->
<div class="po" id="panO" onclick="clPn()"></div>
<div class="pn" id="pan"><div class="pn-h"><h3 id="panTitle">Panel</h3><button class="btn btn-o btn-sm" onclick="clPn()">‚úï</button></div><div class="pn-b" id="panB"></div></div>
<div class="tst-c" id="tC"></div>

<script>
const S={connected:false,store:null,company:'COMZA',products:[],demo:false};
const API='';
let refDB;

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init(){
    await initDB();
    await checkConnection();
    await loadRefStats();
    await loadHerrStats();
}

// ‚îÄ‚îÄ‚îÄ IndexedDB for Refacciones & Herramientas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDB(){return new Promise((ok,fail)=>{
    const req=indexedDB.open('COMZA_Inventarios',2);
    req.onupgradeneeded=e=>{const db=e.target.result;
        if(!db.objectStoreNames.contains('refs')){const s=db.createObjectStore('refs',{keyPath:'id',autoIncrement:true});s.createIndex('nombre','nombre');s.createIndex('estado','estado')}
        if(!db.objectStoreNames.contains('herr')){const s=db.createObjectStore('herr',{keyPath:'id',autoIncrement:true});s.createIndex('nombre','nombre');s.createIndex('estado','estado')}};
    req.onsuccess=e=>{refDB=e.target.result;ok()};req.onerror=e=>fail(e)})}

// Refacciones DB
function dbTx(mode='readonly'){return refDB.transaction('refs',mode).objectStore('refs')}
function dbGetAll(){return new Promise(ok=>{dbTx().getAll().onsuccess=e=>ok(e.target.result)})}
function dbAdd(r){return new Promise(ok=>{dbTx('readwrite').add(r).onsuccess=e=>ok(e.target.result)})}
function dbPut(r){return new Promise(ok=>{dbTx('readwrite').put(r).onsuccess=e=>ok(e.target.result)})}
function dbDel(id){return new Promise(ok=>{dbTx('readwrite').delete(id).onsuccess=e=>ok()})}
// Herramientas DB
function hTx(mode='readonly'){return refDB.transaction('herr',mode).objectStore('herr')}
function hGetAll(){return new Promise(ok=>{hTx().getAll().onsuccess=e=>ok(e.target.result)})}
function hAdd(r){return new Promise(ok=>{hTx('readwrite').add(r).onsuccess=e=>ok(e.target.result)})}
function hPut(r){return new Promise(ok=>{hTx('readwrite').put(r).onsuccess=e=>ok(e.target.result)})}
function hDel(id){return new Promise(ok=>{hTx('readwrite').delete(id).onsuccess=e=>ok()})}

// ‚îÄ‚îÄ‚îÄ CONNECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkConnection(){
    try{const r=await fetch(API+'/api/health');const d=await r.json();
        if(d.connected){S.connected=true;S.store=d.store;S.company=d.company||'COMZA';S.demo=false;updSt(true);go('products');await fetchProducts();toast('Conectado a '+S.store,'ok')}
        else{updSt(false)}}catch(e){updSt(false)}}

function updSt(on){
    document.getElementById('dot').className='sb-dot'+(on?' on':'');
    document.getElementById('dotT').textContent=on?(S.store||'Conectado'):'Sin conexi√≥n';
    document.getElementById('cfS').textContent=on?S.store:'No conectada';
    const t=document.getElementById('cfT');t.className=on?'tag tag-g':'tag tag-r';t.textContent=on?'Conectada':'Desconectada'}

function go(v){
    if(!S.connected&&!S.demo&&v!=='connect'&&v!=='settings'&&v!=='refacciones'&&v!=='ref-label'&&v!=='herramientas'){return}
    document.querySelectorAll('.v').forEach(x=>x.classList.remove('on'));document.querySelectorAll('.sb-link').forEach(x=>x.classList.remove('on'));
    const el=document.getElementById('v-'+v);if(el)el.classList.add('on');
    document.querySelector(`.sb-link[data-v="${v}"]`)?.classList.add('on');
    if(v==='label')popSel();if(v==='refacciones')renderRefs();if(v==='ref-label')popRefSel();if(v==='herramientas')renderHerr()}

// ‚îÄ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchProducts(){
    if(S.demo)return;const g=document.getElementById('grid');g.innerHTML='<div class="loading"><div class="spinner"></div>Cargando...</div>';
    try{const r=await fetch(API+'/api/products');const d=await r.json();
        if(d.error){toast(d.error,'err');return}S.products=d.products||[];renderP(S.products)}catch(e){toast('Error de conexi√≥n','err')}}

function renderP(p){
    document.getElementById('nc').textContent=p.length;document.getElementById('sT').textContent=p.length;
    document.getElementById('sS').textContent=p.filter(x=>x.sku).length;document.getElementById('sN').textContent=p.filter(x=>!x.sku).length;
    document.getElementById('sI').textContent=p.reduce((a,x)=>a+(x.inventory_quantity||0),0);
    const g=document.getElementById('grid');
    if(!p.length){g.innerHTML='<div class="empty" style="grid-column:1/-1"><h3>Sin productos</h3></div>';return}
    g.innerHTML=p.map(x=>`<div class="pc" onclick="opEd(${x.id})">
        <div class="pc-img">${x.image?`<img src="${x.image}" loading="lazy">`:'<div style="color:var(--t4);font-size:10px">Sin imagen</div>'}</div>
        <div class="pc-bd"><div class="pc-t">${esc(x.title)}</div><div class="pc-sku">${x.sku?'SKU: '+esc(x.sku):'<span style="color:var(--t4)">Sin SKU</span>'}</div>
        <div class="pc-pr">$${fN(x.price)}<span class="c">MXN</span></div><div class="pc-stk">Stock: ${x.inventory_quantity||0}</div></div>
        <div class="pc-ft"><button class="btn btn-o" onclick="event.stopPropagation();opEd(${x.id})">Editar</button><button class="btn btn-g" onclick="event.stopPropagation();goL(${x.id})">Etiqueta</button></div></div>`).join('')}

function filterP(){const q=document.getElementById('q').value.toLowerCase().trim();if(!q)return renderP(S.products);
    renderP(S.products.filter(p=>p.title.toLowerCase().includes(q)||p.sku.toLowerCase().includes(q)||(p.product_type||'').toLowerCase().includes(q)||(p.vendor||'').toLowerCase().includes(q)))}

function opEd(id){const p=S.products.find(x=>x.id===id);if(!p)return;
    const cashPrice=parseFloat(p.price||0)*0.9;
    // Load saved meta from localStorage
    const meta=JSON.parse(localStorage.getItem('comza_meta_'+id)||'{}');
    document.getElementById('panTitle').textContent='Editar Producto';
    document.getElementById('panB').innerHTML=`<div class="pn-img">${p.image?`<img src="${p.image}">`:'<div style="color:var(--t4);font-size:10px">Sin imagen</div>'}</div>
        <div class="fg"><label>Nombre</label><input type="text" id="eT" value="${escA(p.title)}"></div>
        <div class="fg-row"><div class="fg"><label>SKU</label><input type="text" id="eS" value="${escA(p.sku)}" style="font-family:var(--mono);font-weight:600"></div><div class="fg"><label>Tipo</label><input type="text" id="eY" value="${escA(p.product_type)}"></div></div>
        <div class="fg-row"><div class="fg"><label>Precio Publicado (IVA)</label><input type="text" id="eP" value="${p.price}"></div><div class="fg"><label>Precio Efectivo (-10%)</label><input type="text" value="$${fN(Math.round(cashPrice).toString())}" disabled style="color:var(--green);font-weight:700"></div></div>
        <div class="fg-row"><div class="fg"><label>Precio comp. (promo)</label><input type="text" id="eC" value="${p.compare_at_price||''}"></div><div class="fg"><label>Marca</label><input type="text" id="eV" value="${escA(p.vendor)}"></div></div>
        <div class="fg"><label>Tags</label><input type="text" id="eG" value="${escA(p.tags)}"></div>
        <div style="margin-top:12px;padding:12px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--border2)">
            <div style="font-size:10px;font-weight:700;color:var(--amber);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">üìã Datos Internos COMZA</div>
            <div class="fg-row"><div class="fg"><label>Fecha de Compra</label><input type="date" id="mFc" value="${escA(meta.fecha_compra||'')}"></div><div class="fg"><label>Lugar de Compra</label><input type="text" id="mLc" value="${escA(meta.lugar_compra||'')}"></div></div>
            <div class="fg"><label>N√∫mero de Pedimento</label><input type="text" id="mPd" value="${escA(meta.pedimento||'')}" style="font-family:var(--mono)"></div>
            <div class="fg-row"><div class="fg"><label>Costo de Adquisici√≥n</label><input type="text" id="mCa" value="${escA(meta.costo_adquisicion||'')}" placeholder="$0"></div><div class="fg"><label>Gasto de Reparaci√≥n</label><input type="text" id="mGr" value="${escA(meta.gasto_reparacion||'')}" placeholder="$0"></div></div>
            <div class="fg-row3"><div class="fg"><label>Energ√≠a</label><input type="text" id="mEn" value="${escA(meta.energia||'')}"></div><div class="fg"><label>Gas</label><input type="text" id="mGs" value="${escA(meta.gas||'')}"></div><div class="fg"><label>Capacidad</label><input type="text" id="mCp" value="${escA(meta.capacidad||'')}"></div></div>
        </div>
        <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-g" onclick="savP(${p.id},${p.variant_id})">Guardar</button></div>
        <div style="text-align:center;margin-top:10px"><button class="btn btn-o btn-sm" onclick="goL(${p.id});clPn()">Imprimir etiqueta ‚Üí</button></div>`;
    opPn()}

async function savP(id,vid){
    const u={title:document.getElementById('eT').value,sku:document.getElementById('eS').value,product_type:document.getElementById('eY').value,price:document.getElementById('eP').value,compare_at_price:document.getElementById('eC').value||null,vendor:document.getElementById('eV').value,tags:document.getElementById('eG').value};
    // Collect metafields for Shopify
    const metafields={fecha_compra:document.getElementById('mFc').value,lugar_compra:document.getElementById('mLc').value,pedimento:document.getElementById('mPd').value,costo_adquisicion:document.getElementById('mCa').value,gasto_reparacion:document.getElementById('mGr').value,energia:document.getElementById('mEn').value,gas:document.getElementById('mGs').value,capacidad:document.getElementById('mCp').value};
    // Also keep local cache for fast label loading
    localStorage.setItem('comza_meta_'+id,JSON.stringify(metafields));
    const i=S.products.findIndex(p=>p.id===id);if(i>=0)S.products[i]={...S.products[i],...u};
    if(!S.demo){try{const r=await fetch(API+`/api/products/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({...u,variants:[{id:vid,sku:u.sku,price:u.price,compare_at_price:u.compare_at_price}],metafields})});const d=await r.json();
        if(d.error)toast('Error: '+JSON.stringify(d.error),'err');else{if(i>=0&&d.product)S.products[i]=d.product;toast('Guardado en Shopify ‚úì','ok')}}catch(e){toast('Error de red','err')}}
    else toast('Guardado (demo)','ok');renderP(S.products);clPn()}

// ‚îÄ‚îÄ‚îÄ PRODUCT LABEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function popSel(){const s=document.getElementById('lSel');s.innerHTML='<option value="">‚Äî Seleccionar ‚Äî</option>'+S.products.map(p=>`<option value="${p.id}">${p.sku?'['+p.sku+'] ':''}${p.title}</option>`).join('')}

function autoCalcCash(){}
function autoCalcPromoCash(){}

function fillL(){const id=parseInt(document.getElementById('lSel').value);if(!id)return;const p=S.products.find(x=>x.id===id);if(!p)return;
    document.getElementById('lNm').value=p.title;document.getElementById('lCd').value='';document.getElementById('lSk').value=p.sku;
    document.getElementById('lPI').value=fN(p.price);
    // Auto-fill cash price as price without IVA (price/1.16) rounded
    const cashAuto=Math.round(parseFloat(p.price||0)/1.16);
    document.getElementById('lPC').value=cashAuto?fN(cashAuto.toString()):'';
    if(p.compare_at_price&&parseFloat(p.compare_at_price)>0){document.getElementById('lHP').checked=true;togPr();document.getElementById('lPrI').value=fN(p.compare_at_price);
        const promoCash=Math.round(parseFloat(p.compare_at_price)/1.16);
        document.getElementById('lPrC').value=promoCash?fN(promoCash.toString()):''}
    else{document.getElementById('lHP').checked=false;togPr()}
    // Load specs from meta
    const meta=JSON.parse(localStorage.getItem('comza_meta_'+id)||'{}');
    const specParts=[];
    if(meta.energia)specParts.push('Luz '+meta.energia);
    if(meta.capacidad)specParts.push(meta.capacidad);
    if(meta.gas)specParts.push('Gas'+(/^[A-Z]/.test(meta.gas)?' ':'')+(meta.gas));
    document.getElementById('lSpTxt').value=specParts.join(' / ')||'';
    updL()}

function goL(id){go('label');setTimeout(()=>{document.getElementById('lSel').value=id;fillL()},50)}
function togPr(){document.getElementById('prF').style.display=document.getElementById('lHP').checked?'block':'none'}

function updL(){
    const nm=document.getElementById('lNm').value,cd=document.getElementById('lCd').value;
    document.getElementById('L-nm').textContent=cd?`${nm} (${cd})`:nm;
    const sku=document.getElementById('lSk').value;
    const skuText=sku?`SKU: ${sku}`:'SKU:';
    const skuEl=document.getElementById('L-sku');
    skuEl.textContent=skuText;
    // Auto-scale SKU font: 48px for short (‚â§10), smaller for longer
    const len=skuText.length;
    if(len<=10)skuEl.style.fontSize='48px';
    else if(len<=15)skuEl.style.fontSize='38px';
    else if(len<=20)skuEl.style.fontSize='30px';
    else skuEl.style.fontSize='24px';
    document.getElementById('L-pi').textContent=`$ ${document.getElementById('lPI').value} MXN`;
    document.getElementById('L-pc').textContent=`$${document.getElementById('lPC').value} MXN`;
    const pr=document.getElementById('lHP').checked;
    document.getElementById('L-prW').style.display=pr?'block':'none';
    document.getElementById('lblP').classList.toggle('has-promo',pr);
    if(pr){document.getElementById('L-pri').textContent=`$ ${document.getElementById('lPrI').value} MXN`;document.getElementById('L-prc').textContent=`$${document.getElementById('lPrC').value} MXN`}
    const spTxt=document.getElementById('lSpTxt').value;
    document.getElementById('L-sp').textContent=spTxt||'';
    document.getElementById('L-sp').style.display=spTxt?'block':'none'}

function printL(){updL();window.print()}

// ‚îÄ‚îÄ‚îÄ REFACCIONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ESTADOS=['Sin informaci√≥n','Funciona','No funciona','Por reparar','En Reparaci√≥n','Baja','En Pr√©stamo'];
const CONDICIONES=['Nueva','Usada'];
function estadoTag(e){const m={'Funciona':'tag-g','No funciona':'tag-r','Por reparar':'tag-a','En Reparaci√≥n':'tag-a','Baja':'tag-r','En Pr√©stamo':'tag-b','Sin informaci√≥n':''};return`<span class="tag ${m[e]||''}">${e}</span>`}

async function renderRefs(){
    const all=await dbGetAll();
    document.getElementById('nR').textContent=all.length;document.getElementById('rT').textContent=all.length;
    document.getElementById('rF').textContent=all.filter(r=>r.estado==='Funciona').length;
    document.getElementById('rP').textContent=all.filter(r=>r.estado==='En Pr√©stamo').length;
    document.getElementById('rB').textContent=all.filter(r=>r.estado==='Baja').length;
    renderRefTable(all)}

async function filterR(){const q=document.getElementById('rQ').value.toLowerCase().trim();const all=await dbGetAll();
    if(!q)return renderRefTable(all);
    renderRefTable(all.filter(r=>(r.nombre||'').toLowerCase().includes(q)||(r.marca||'').toLowerCase().includes(q)||(r.modelo||'').toLowerCase().includes(q)||(r.capacidad||'').toLowerCase().includes(q)||(r.compatibles||'').toLowerCase().includes(q)||(r.condicion||'').toLowerCase().includes(q)||(r.estado||'').toLowerCase().includes(q)))}

function renderRefTable(refs){const g=document.getElementById('rGrid');
    if(!refs.length){g.innerHTML='<tr><td colspan="6"><div class="empty"><h3>Sin refacciones</h3><p>Agrega tu primera refacci√≥n</p></div></td></tr>';return}
    g.innerHTML=refs.map(r=>`<tr>
        <td style="font-weight:600">${esc(r.nombre||'')}</td><td>${esc(r.marca||'')}</td><td>${esc(r.modelo||'')}</td>
        <td><span class="tag ${r.condicion==='Nueva'?'tag-g':'tag-a'}">${r.condicion||''}</span></td>
        <td>${estadoTag(r.estado||'Sin informaci√≥n')}</td>
        <td><div style="display:flex;gap:4px">
            <button class="btn btn-o btn-sm" onclick="opRefEdit(${r.id})">‚úèÔ∏è</button>
            <button class="btn btn-b btn-sm" onclick="opRefPrestamo(${r.id})">üì§</button>
            <button class="btn btn-r btn-sm" onclick="opRefBaja(${r.id})">‚õî</button>
            <button class="btn btn-o btn-sm" onclick="goRL(${r.id})">üè∑Ô∏è</button>
        </div></td></tr>`).join('')}

async function loadRefStats(){const all=await dbGetAll();document.getElementById('nR').textContent=all.length}

function opRefNew(){
    document.getElementById('panTitle').textContent='Nueva Refacci√≥n';
    document.getElementById('panB').innerHTML=refForm({});opPn()}

function refForm(r){return`
    <div class="fg"><label>Nombre de la Refacci√≥n</label><input type="text" id="rfNm" value="${escA(r.nombre||'')}"></div>
    <div class="fg-row"><div class="fg"><label>Marca</label><input type="text" id="rfMa" value="${escA(r.marca||'')}"></div><div class="fg"><label>Modelo</label><input type="text" id="rfMo" value="${escA(r.modelo||'')}"></div></div>
    <div class="fg"><label>Capacidad</label><input type="text" id="rfCa" value="${escA(r.capacidad||'')}"></div>
    <div class="fg"><label>Equipos Compatibles</label><input type="text" id="rfCo" value="${escA(r.compatibles||'')}" placeholder="Ej: Horno Rational SCC 202, Combi Hobart"></div>
    <div class="fg-row"><div class="fg"><label>Condici√≥n</label><select id="rfCn">${CONDICIONES.map(c=>`<option${c===r.condicion?' selected':''}>${c}</option>`).join('')}</select></div>
    <div class="fg"><label>Estado</label><select id="rfEs">${ESTADOS.map(e=>`<option${e===r.estado?' selected':''}>${e}</option>`).join('')}</select></div></div>
    <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-g" onclick="saveRef(${r.id||0})">Guardar</button></div>`}

async function saveRef(id){
    const d={nombre:document.getElementById('rfNm').value,marca:document.getElementById('rfMa').value,modelo:document.getElementById('rfMo').value,capacidad:document.getElementById('rfCa').value,compatibles:document.getElementById('rfCo').value,condicion:document.getElementById('rfCn').value,estado:document.getElementById('rfEs').value};
    if(!d.nombre){toast('Nombre requerido','err');return}
    if(id){d.id=id;await dbPut(d);toast('Actualizado ‚úì','ok')}else{await dbAdd(d);toast('Refacci√≥n agregada ‚úì','ok')}
    clPn();renderRefs()}

async function opRefEdit(id){const all=await dbGetAll();const r=all.find(x=>x.id===id);if(!r)return;
    document.getElementById('panTitle').textContent='Editar Refacci√≥n';document.getElementById('panB').innerHTML=refForm(r);opPn()}

async function opRefPrestamo(id){const all=await dbGetAll();const r=all.find(x=>x.id===id);if(!r)return;
    document.getElementById('panTitle').textContent='Salida en Pr√©stamo';
    document.getElementById('panB').innerHTML=`<div style="margin-bottom:12px;font-size:13px;font-weight:600">${esc(r.nombre)}</div>
    <div class="fg"><label>Fecha de Pr√©stamo</label><input type="date" id="prFe" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="fg"><label>Persona Responsable</label><input type="text" id="prPe" placeholder="Nombre del responsable"></div>
    <div class="fg"><label>Descripci√≥n</label><textarea id="prDe" placeholder="Motivo del pr√©stamo..."></textarea></div>
    <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-b" onclick="doPrestamo(${id})">Confirmar Pr√©stamo</button></div>`;opPn()}

async function doPrestamo(id){const all=await dbGetAll();const r=all.find(x=>x.id===id);if(!r)return;
    r.estado='En Pr√©stamo';r.prestamo={fecha:document.getElementById('prFe').value,persona:document.getElementById('prPe').value,descripcion:document.getElementById('prDe').value};
    await dbPut(r);toast('Pr√©stamo registrado ‚úì','ok');clPn();renderRefs()}

async function opRefBaja(id){const all=await dbGetAll();const r=all.find(x=>x.id===id);if(!r)return;
    document.getElementById('panTitle').textContent='Dar de Baja';
    document.getElementById('panB').innerHTML=`<div style="margin-bottom:12px;font-size:13px;font-weight:600;color:var(--red)">${esc(r.nombre)}</div>
    <div class="fg"><label>Fecha de Baja</label><input type="date" id="baFe" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="fg"><label>Persona Responsable</label><input type="text" id="baPe" placeholder="Nombre del responsable"></div>
    <div class="fg"><label>Descripci√≥n / Motivo</label><textarea id="baDe" placeholder="Motivo de la baja..."></textarea></div>
    <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-r" onclick="doBaja(${id})">Confirmar Baja</button></div>`;opPn()}

async function doBaja(id){const all=await dbGetAll();const r=all.find(x=>x.id===id);if(!r)return;
    r.estado='Baja';r.baja={fecha:document.getElementById('baFe').value,persona:document.getElementById('baPe').value,descripcion:document.getElementById('baDe').value};
    await dbPut(r);toast('Baja registrada ‚úì','ok');clPn();renderRefs()}

// ‚îÄ‚îÄ‚îÄ REFACCION LABEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function popRefSel(){const all=await dbGetAll();const s=document.getElementById('rlSel');
    s.innerHTML='<option value="">‚Äî Seleccionar ‚Äî</option>'+all.map(r=>`<option value="${r.id}">${r.nombre} (${r.marca||''})</option>`).join('')}

async function fillRL(){const id=parseInt(document.getElementById('rlSel').value);if(!id)return;
    const all=await dbGetAll();const r=all.find(x=>x.id===id);if(!r)return;
    document.getElementById('rlNm').value=r.nombre;document.getElementById('rlCd').value=r.condicion||'Nueva';
    document.getElementById('rlId').value='REF-'+String(r.id).padStart(4,'0');updRL()}

function goRL(id){go('ref-label');setTimeout(()=>{document.getElementById('rlSel').value=id;fillRL()},50)}

function updRL(){
    const nm=document.getElementById('rlNm').value||'Refacci√≥n';const cd=document.getElementById('rlCd').value;const rid=document.getElementById('rlId').value||'REF-0000';
    document.getElementById('RL-nm').textContent=nm;document.getElementById('RL-cd').textContent=cd;
    const qrDiv=document.getElementById('rlQR');qrDiv.innerHTML='';
    const qrData=JSON.stringify({id:rid,nombre:nm,condicion:cd,empresa:'Grupo COMZA'});
    new QRCode(qrDiv,{text:qrData,width:76,height:76,colorDark:'#000',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.M})}

function printRL(){updRL();setTimeout(()=>window.print(),200)}

// ‚îÄ‚îÄ‚îÄ EXPORT/IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportRef(){const all=await dbGetAll();const b=new Blob([JSON.stringify(all,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='comza-refacciones-'+new Date().toISOString().slice(0,10)+'.json';a.click();toast('Exportado ‚úì','ok')}

async function importRef(e){const f=e.target.files[0];if(!f)return;const t=await f.text();try{const arr=JSON.parse(t);
    for(const r of arr){delete r.id;await dbAdd(r)}toast(`${arr.length} refacciones importadas ‚úì`,'ok');renderRefs()}catch(er){toast('Error en archivo','err')}}

// ‚îÄ‚îÄ‚îÄ PNG DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function dlPNG(elId,prefix){try{const c=await html2canvas(document.getElementById(elId),{scale:3,backgroundColor:'#fff'});const a=document.createElement('a');a.download=`${prefix}-${Date.now()}.png`;a.href=c.toDataURL('image/png');a.click();toast('PNG descargado','ok')}catch(e){toast('Error','err')}}

// ‚îÄ‚îÄ‚îÄ DEMO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadDemo(){S.connected=true;S.demo=true;S.store='grupocomza.com';S.company='COMZA';
    S.products=[{id:1,title:'Horno Combi Rational SCC WE 202G',body_html:'220v / 1 ph / 20 Charolas / Gas',vendor:'Rational',product_type:'Hornos',tags:'',sku:'E258',price:'518400.00',compare_at_price:'473000.00',inventory_quantity:2,image:null,variant_id:101,status:'active'},
    {id:2,title:'Refrigerador Industrial True T-49',body_html:'110v / 1 ph / 49 cu.ft.',vendor:'True',product_type:'Refrigeraci√≥n',tags:'',sku:'R101',price:'45600.00',compare_at_price:null,inventory_quantity:5,image:null,variant_id:102,status:'active'},
    {id:3,title:'Freidora Doble Pitco SSH55',body_html:'Gas LP / 2 canastas / 35 lbs',vendor:'Pitco',product_type:'Cocci√≥n',tags:'',sku:'F301',price:'121000.00',compare_at_price:'110000.00',inventory_quantity:4,image:null,variant_id:103,status:'active'}];
    updSt(true);renderP(S.products);go('products');toast('Demo cargado','ok')}

// ‚îÄ‚îÄ‚îÄ PANEL / TOAST / UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function opPn(){document.getElementById('pan').classList.add('on');document.getElementById('panO').classList.add('on')}
function clPn(){document.getElementById('pan').classList.remove('on');document.getElementById('panO').classList.remove('on')}
function fN(s){return parseFloat(s||'0').toLocaleString('es-MX',{maximumFractionDigits:0})}
function parseNum(s){return parseInt((s||'0').replace(/[^0-9]/g,''))||0}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function escA(s){return(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function toast(m,t='inf'){const c=document.getElementById('tC'),e=document.createElement('div');e.className=`tst ${t}`;e.innerHTML=`<span>${{ok:'‚úì',err:'‚úó',inf:'‚Ñπ'}[t]||'‚Ñπ'}</span> ${m}`;c.appendChild(e);setTimeout(()=>{e.style.opacity='0';e.style.transition='.2s';setTimeout(()=>e.remove(),200)},3000)}

// ‚îÄ‚îÄ‚îÄ NEW PRODUCT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function opNewProd(){
    document.getElementById('panTitle').textContent='Nuevo Producto en Shopify';
    document.getElementById('panB').innerHTML=`
        <div class="fg"><label>Nombre del Producto</label><input type="text" id="npT" placeholder="Horno Combi Rational SCC WE 202G"></div>
        <div class="fg-row"><div class="fg"><label>SKU</label><input type="text" id="npS" style="font-family:var(--mono);font-weight:600" placeholder="E258"></div><div class="fg"><label>Tipo</label><input type="text" id="npY" placeholder="Hornos"></div></div>
        <div class="fg-row"><div class="fg"><label>Precio Publicado (IVA)</label><input type="text" id="npP" placeholder="518400"></div><div class="fg"><label>Precio Promo</label><input type="text" id="npC" placeholder="(Opcional)"></div></div>
        <div class="fg"><label>Marca / Vendor</label><input type="text" id="npV" placeholder="Rational"></div>
        <div class="fg"><label>Tags</label><input type="text" id="npG" placeholder="reacondicionado, horno"></div>
        <div style="margin-top:8px;padding:12px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--border2)">
            <div style="font-size:10px;font-weight:700;color:var(--amber);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px">üìã Datos Internos COMZA</div>
            <div class="fg-row"><div class="fg"><label>Fecha de Compra</label><input type="date" id="npFc"></div><div class="fg"><label>Lugar de Compra</label><input type="text" id="npLc"></div></div>
            <div class="fg"><label>N√∫mero de Pedimento</label><input type="text" id="npPd" style="font-family:var(--mono)"></div>
            <div class="fg-row"><div class="fg"><label>Costo de Adquisici√≥n</label><input type="text" id="npCa" placeholder="$0"></div><div class="fg"><label>Gasto de Reparaci√≥n</label><input type="text" id="npGr" placeholder="$0"></div></div>
            <div class="fg-row3"><div class="fg"><label>Energ√≠a</label><input type="text" id="npEn" placeholder="220v / 1 ph"></div><div class="fg"><label>Gas</label><input type="text" id="npGs" placeholder="LP / Natural"></div><div class="fg"><label>Capacidad</label><input type="text" id="npCp" placeholder="20 Charolas"></div></div>
        </div>
        <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-g" onclick="createProd()">Crear en Shopify</button></div>`;
    opPn()}

async function createProd(){
    const d={title:document.getElementById('npT').value,sku:document.getElementById('npS').value,product_type:document.getElementById('npY').value,price:document.getElementById('npP').value||'0',compare_at_price:document.getElementById('npC').value||null,vendor:document.getElementById('npV').value,tags:document.getElementById('npG').value,
        metafields:{fecha_compra:document.getElementById('npFc').value,lugar_compra:document.getElementById('npLc').value,pedimento:document.getElementById('npPd').value,costo_adquisicion:document.getElementById('npCa').value,gasto_reparacion:document.getElementById('npGr').value,energia:document.getElementById('npEn').value,gas:document.getElementById('npGs').value,capacidad:document.getElementById('npCp').value}};
    if(!d.title){toast('Nombre requerido','err');return}
    if(S.demo){const fake={id:Date.now(),title:d.title,sku:d.sku,price:d.price,compare_at_price:d.compare_at_price,vendor:d.vendor,product_type:d.product_type,tags:d.tags,inventory_quantity:0,image:null,variant_id:Date.now()+1,status:'active',body_html:''};S.products.push(fake);renderP(S.products);clPn();toast('Producto creado (demo)','ok');return}
    try{const r=await fetch(API+'/api/products',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});const res=await r.json();
        if(res.error){toast('Error: '+JSON.stringify(res.error),'err');return}
        if(res.product){S.products.push(res.product);localStorage.setItem('comza_meta_'+res.product.id,JSON.stringify(d.metafields));renderP(S.products)}
        toast('Producto creado en Shopify ‚úì','ok');clPn()}catch(e){toast('Error de red','err')}}

// ‚îÄ‚îÄ‚îÄ HERRAMIENTAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const H_ESTADOS=['Disponible','En Pr√©stamo','En Reparaci√≥n','Baja'];

async function renderHerr(){
    const all=await hGetAll();
    document.getElementById('nH').textContent=all.length;document.getElementById('hT').textContent=all.length;
    document.getElementById('hD').textContent=all.filter(h=>h.estado==='Disponible').length;
    document.getElementById('hP').textContent=all.filter(h=>h.estado==='En Pr√©stamo').length;
    document.getElementById('hB').textContent=all.filter(h=>h.estado==='Baja').length;
    renderHerrTable(all)}

async function filterHerr(){const q=document.getElementById('hQ').value.toLowerCase().trim();const all=await hGetAll();
    if(!q)return renderHerrTable(all);
    renderHerrTable(all.filter(h=>(h.nombre||'').toLowerCase().includes(q)||(h.marca||'').toLowerCase().includes(q)||(h.modelo||'').toLowerCase().includes(q)||(h.serie||'').toLowerCase().includes(q)||(h.estado||'').toLowerCase().includes(q)||(h.ubicacion||'').toLowerCase().includes(q)))}

function hEstadoTag(e){const m={'Disponible':'tag-g','En Pr√©stamo':'tag-b','En Reparaci√≥n':'tag-a','Baja':'tag-r'};return`<span class="tag ${m[e]||''}">${e}</span>`}

function renderHerrTable(herrs){const g=document.getElementById('hGrid');
    if(!herrs.length){g.innerHTML='<tr><td colspan="6"><div class="empty"><h3>Sin herramientas</h3><p>Agrega tu primera herramienta</p></div></td></tr>';return}
    g.innerHTML=herrs.map(h=>`<tr>
        <td style="font-weight:600">${esc(h.nombre||'')}</td><td>${esc(h.marca||'')}</td><td>${esc(h.modelo||'')}</td>
        <td style="font-family:var(--mono);font-size:10px">${esc(h.serie||'‚Äî')}</td>
        <td>${hEstadoTag(h.estado||'Disponible')}</td>
        <td><div style="display:flex;gap:4px">
            <button class="btn btn-o btn-sm" onclick="opHerrEdit(${h.id})">‚úèÔ∏è</button>
            <button class="btn btn-b btn-sm" onclick="opHerrPrest(${h.id})">üì§</button>
            <button class="btn btn-r btn-sm" onclick="opHerrBaja(${h.id})">‚õî</button>
        </div></td></tr>`).join('')}

async function loadHerrStats(){const all=await hGetAll();document.getElementById('nH').textContent=all.length}

function opHerrNew(){
    document.getElementById('panTitle').textContent='Nueva Herramienta';
    document.getElementById('panB').innerHTML=herrForm({});opPn()}

function herrForm(h){return`
    <div class="fg"><label>Nombre de la Herramienta</label><input type="text" id="hfNm" value="${escA(h.nombre||'')}"></div>
    <div class="fg-row"><div class="fg"><label>Marca</label><input type="text" id="hfMa" value="${escA(h.marca||'')}"></div><div class="fg"><label>Modelo</label><input type="text" id="hfMo" value="${escA(h.modelo||'')}"></div></div>
    <div class="fg-row"><div class="fg"><label>N√∫mero de Serie</label><input type="text" id="hfSe" value="${escA(h.serie||'')}" style="font-family:var(--mono)"></div><div class="fg"><label>Ubicaci√≥n</label><input type="text" id="hfUb" value="${escA(h.ubicacion||'')}"></div></div>
    <div class="fg"><label>Descripci√≥n</label><textarea id="hfDe">${escA(h.descripcion||'')}</textarea></div>
    <div class="fg"><label>Estado</label><select id="hfEs">${H_ESTADOS.map(e=>`<option${e===h.estado?' selected':''}>${e}</option>`).join('')}</select></div>
    <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-g" onclick="saveHerr(${h.id||0})">Guardar</button></div>`}

async function saveHerr(id){
    const d={nombre:document.getElementById('hfNm').value,marca:document.getElementById('hfMa').value,modelo:document.getElementById('hfMo').value,serie:document.getElementById('hfSe').value,ubicacion:document.getElementById('hfUb').value,descripcion:document.getElementById('hfDe').value,estado:document.getElementById('hfEs').value};
    if(!d.nombre){toast('Nombre requerido','err');return}
    if(id){d.id=id;await hPut(d);toast('Herramienta actualizada ‚úì','ok')}else{await hAdd(d);toast('Herramienta agregada ‚úì','ok')}
    clPn();renderHerr()}

async function opHerrEdit(id){const all=await hGetAll();const h=all.find(x=>x.id===id);if(!h)return;
    document.getElementById('panTitle').textContent='Editar Herramienta';document.getElementById('panB').innerHTML=herrForm(h);opPn()}

async function opHerrPrest(id){const all=await hGetAll();const h=all.find(x=>x.id===id);if(!h)return;
    document.getElementById('panTitle').textContent='Pr√©stamo de Herramienta';
    document.getElementById('panB').innerHTML=`<div style="margin-bottom:12px;font-size:13px;font-weight:600">${esc(h.nombre)}</div>
    <div class="fg"><label>Fecha de Pr√©stamo</label><input type="date" id="hpFe" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="fg"><label>Persona Responsable</label><input type="text" id="hpPe" placeholder="Nombre del responsable"></div>
    <div class="fg"><label>Descripci√≥n</label><textarea id="hpDe" placeholder="Motivo del pr√©stamo..."></textarea></div>
    <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-b" onclick="doHerrPrest(${id})">Confirmar Pr√©stamo</button></div>`;opPn()}

async function doHerrPrest(id){const all=await hGetAll();const h=all.find(x=>x.id===id);if(!h)return;
    h.estado='En Pr√©stamo';h.prestamo={fecha:document.getElementById('hpFe').value,persona:document.getElementById('hpPe').value,descripcion:document.getElementById('hpDe').value};
    await hPut(h);toast('Pr√©stamo registrado ‚úì','ok');clPn();renderHerr()}

async function opHerrBaja(id){const all=await hGetAll();const h=all.find(x=>x.id===id);if(!h)return;
    document.getElementById('panTitle').textContent='Baja de Herramienta';
    document.getElementById('panB').innerHTML=`<div style="margin-bottom:12px;font-size:13px;font-weight:600;color:var(--red)">${esc(h.nombre)}</div>
    <div class="fg"><label>Fecha de Baja</label><input type="date" id="hbFe" value="${new Date().toISOString().split('T')[0]}"></div>
    <div class="fg"><label>Persona Responsable</label><input type="text" id="hbPe" placeholder="Nombre del responsable"></div>
    <div class="fg"><label>Descripci√≥n / Motivo</label><textarea id="hbDe" placeholder="Motivo de la baja..."></textarea></div>
    <div class="pn-act"><button class="btn btn-o" onclick="clPn()">Cancelar</button><button class="btn btn-r" onclick="doHerrBaja(${id})">Confirmar Baja</button></div>`;opPn()}

async function doHerrBaja(id){const all=await hGetAll();const h=all.find(x=>x.id===id);if(!h)return;
    h.estado='Baja';h.baja={fecha:document.getElementById('hbFe').value,persona:document.getElementById('hbPe').value,descripcion:document.getElementById('hbDe').value};
    await hPut(h);toast('Baja registrada ‚úì','ok');clPn();renderHerr()}

// ‚îÄ‚îÄ‚îÄ HERRAMIENTAS EXPORT/IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportHerr(){const all=await hGetAll();const b=new Blob([JSON.stringify(all,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='comza-herramientas-'+new Date().toISOString().slice(0,10)+'.json';a.click();toast('Exportado ‚úì','ok')}

async function importHerr(e){const f=e.target.files[0];if(!f)return;const t=await f.text();try{const arr=JSON.parse(t);
    for(const h of arr){delete h.id;await hAdd(h)}toast(`${arr.length} herramientas importadas ‚úì`,'ok');renderHerr()}catch(er){toast('Error en archivo','err')}}

init();
</script>
</body>
</html>
